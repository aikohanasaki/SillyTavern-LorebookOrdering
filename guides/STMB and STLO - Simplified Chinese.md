[链接至 ST 记忆书 (STMB)](https://github.com/aikohanasaki/SillyTavern-MemoryBooks) | [链接至 ST 知识库排序 (STLO)](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering)

# 🧠 终极记忆指南：STMB + STLO

ST 记忆书 (STMB) 对**生成记忆内容**至关重要，而 ST 知识库排序 (STLO) 则对**确保这些内容被 AI 实际使用**至关重要。当两者结合使用时，它们解决了**记忆排斥**的核心问题。

## 步骤 1：奠定基础

**强制“均匀排序”：** 首先确保 SillyTavern 的默认世界信息 (WI) 设置为允许 STLO 接管。在 SillyTavern **世界信息设置**中，将**世界信息插入策略**设置为**“均匀排序”**。STLO 需要此策略以绕过 SillyTavern 基础代码的僵化分类排序（聊天 → 角色卡 → 等）。

## 步骤 2：创建记忆内容（STMB 的作用）

使用 STMB 自动生成长期记忆。

1.  **启用自动摘要：** 前往 STMB 面板（魔术棒 🪄）并开启**自动摘要**。设置您偏好的间隔（如**30 条消息**）。
2.  **绑定/创建记忆书：** 确保您的聊天有专门用于记忆的知识库。STMB 通常会把记忆放在全局类型的书里，但为了简便，常用绑定到聊天的知识库。
3.  **正常聊天：** 随着聊天进行，STMB 会自动生成高密度、高质量、结构化的摘要。这些记忆就像试图登上 AI 有限上下文“航班”的“乘客”。

## 步骤 3：保证优先级（STLO 的作用）

这是最关键的一步。您必须用 STLO 手动降低**聊天绑定 STMB 书**的优先级，同时提升**角色核心设定**。

### A. 打破“聊天优先”陷阱
默认情况下，聊天绑定的记忆书被赋予**最高优先级**（聊天优先），有可能占用过多上下文空间，排挤其他世界、角色或用户知识库。STLO 允许通过重新分配自定义优先级来解决。

### B. 推荐优先级顺序

为所有相关知识库设置自定义优先级：

### 理解优先级 vs 位置

**位置**决定内容在上下文中*出现的位置*（Char up、Char down、AN up/down、@D 等）。  
**优先级**决定*预算保护*——当上下文达到限制时，哪些内容被保留。

优先级数字越高，被截断的保护越强。优先级**只在每个位置内**生效，而非跨位置。

---

### STLO 优先级设置建议

| 知识库/记忆类型 | 推荐优先级 | 说明 |
|:--------------------|:-------------|:------|
| **角色核心设定**（性格、描述、核心特征） | **优先级 5**（最高） | **最大保护。** 角色卡信息是机器人身份与行为基础。不能被截断或丢失。位置通常由机器人作者设定（Char/AN down 或 @D）。 |
| **世界知识**（设定、阵营、地点、规则） | **优先级 4**（高，设定预算） | **高但可控保护。** 世界观为机器人提供必要上下文，需预算限制防膨胀，确保核心信息不丢失。如需截断，先于角色核心设定。 |
| **Persona**（您的身份） | **优先级 2-3**（中） | **中等保护。** 用户身份信息对个性化回复重要，但部分被截断机器人仍可工作。比角色/世界设定优先级低。 |
| **指令/常规** | **优先级 2-3**（中） | **中等保护。** 行为指令和格式命令。对回复质量重要，尤其由机器人作者放在 @D，但不如角色完整性关键。 |
| **记忆**（STMB、回忆事件） | **优先级 1**（最低，设定预算） | **最少保护，强力修剪。** 记忆应放在 Char up（上下文开头），作为补充信息而非核心。当大量记忆被触发时，大部分可安全截断。预算防止记忆占据关键信息空间。 |

---

### 核心原则

1. **保护不可替代内容：** 角色核心设定丢失无法恢复。
2. **对易膨胀内容设预算：** 世界知识和记忆可触发多条，必须限制数量。
3. **位置独立：** 优先级 1 项在 @D 仍在底部，满上下文时最先被截断。
4. **信任机器人作者：** 好的机器人会把关键信息放在 @D，不受优先级设置影响。

---

## C. 设置预算上限

- **角色核心设定：** 无上限（通常较紧凑）
- **世界知识：** 最多 15,000–25,000 token
- **Persona：** 无上限（通常较紧凑）
- **指令/常规：** 无上限（通常较紧凑）
- **记忆：** 最多 5,000–15,000 token（强力修剪）

1.  打开 STMB 记忆书的 STLO 配置。
2.  设置**预算**上限（如**固定 token** `5000` 或**上下文百分比** `15%`）。
3.  这样即使知识库被优先处理，也会自动修剪，自留空间给优先级 3、2、1 的知识库。

---

**备注：** 部分术语和技术细节建议由熟悉 SillyTavern/STMB/STLO 的中文母语者复核，确保准确性和一致性。
