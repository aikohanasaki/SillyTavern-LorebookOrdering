# 📚 ロアブックの順序付け (SillyTavern拡張機能)

---

🌐 **日本語の詳細な使い方ガイドもご覧ください：**
👉 [STMB と STLO ガイド（日本語）](../guides/STMB%20and%20STLO%20-%20Japanese.md)

---

💡 **記憶管理を最大限に活用したい方へ：**
STLOは[SillyTavern-MemoryBooks (STMB)](https://github.com/aikohanasaki/SillyTavern-MemoryBooks)と組み合わせて使うのが最適です！  
セットアップのコツや記憶の優先順位設定については[STMB + STLOガイド](../guides/STMB%20and%20STLO%20-%20Japanese.md)をご覧ください。

---

World Infoにロアブックレベルの優先度管理と予算設定を追加するSillyTavern拡張機能です。どのロアブックを最初にアクティブにするかを完全に制御し、「貪欲な」ロアブックを制限することができます。World Infoの動作を細かく制御する必要がある複数のロアブックを持つユーザーに最適です。

🆕 **グループチャットでのキャラクター固有のオーバーライドと正確な順序調整をサポートしました！**

**📋 [バージョン履歴と変更ログ](CHANGELOG.md)**

## よくある質問
設定は、ワールド情報パネルの「ロアブックの順序付け」ボタン（ロアブックが利用可能な場合に検索ボックスの横に表示されます）からアクセスします。

![STLO Button](https://github.com/aikohanasaki/imagehost/blob/main/STLO.png)

---

## 📋 前提条件

- **SillyTavern:** 1.13.5以降（最新版を推奨）
- **ワールド情報戦略:** STLOが機能するには、「均等に」挿入戦略を使用する必要があります
- **複数のロアブック:** 優先順位付けが必要な複数のロアブックがある場合に最も役立ちます

## 💡 推奨されるグローバルワールド情報/ロアブックのアクティベーション設定
これらの設定でテスト済みです：

- **挿入戦略:** 「均等に」（STLOが機能するために必要）
- **最大再帰ステップ:** 2（一般的な推奨）

---

## 🚀 はじめに

### 1. **インストールと設定**
- SillyTavernの拡張機能フォルダに拡張機能をインストールします
- 複数のロアブックが利用可能であることを確認します
- SillyTavernの設定でワールド情報の挿入戦略を「均等に」に設定します

![Extension Button](https://github.com/aikohanasaki/imagehost/blob/main/settings.png)

### 2. **設定へのアクセス**
- SillyTavernでワールド情報パネルを開きます
- 検索ボックスの横にある「ロアブックの順序付け」ボタンを探します
- クリックしてロアブック管理モーダルを開きます

### 3. **優先度の設定**
- ドロップダウンからロアブックを選択します
- 優先度レベルを設定します（1=最低から5=最高、3=デフォルト）
- 必要に応じて予算を設定します
- 必要に応じて順序調整を設定します
- 保存して他のロアブックに対しても繰り返します

![Basic (global) settings](https://github.com/aikohanasaki/imagehost/blob/main/STLO%20basic.png)

---

## 🎯 優先度レベル

### **優先度システム**
- **最高 (5):** ロアブックのエントリが最初にアクティブになり、予算配分で優先されます
- **高 (4):** デフォルトより高い優先度
- **デフォルト (3):** 標準のSillyTavernの動作（オリジナルから変更なし）
- **低 (2):** デフォルトより低い優先度
- **最低 (1):** ロアブックのエントリが最後にアクティブになります

### **仕組み**
- 優先度の高いロアブックは、ワールド情報のアクティベーション中に最初に処理されます
- 「均等に」挿入戦略でのみ機能します

---

## 📊 順序調整システム

### **優先度を超えた微調整**
順序調整システムにより、同じ優先度レベル内でのロアブックエントリの処理順序を正確に制御できます：

- **調整範囲:** 優先度の計算に加えて-10,000から+10,000の値
- **正確な制御:** 優先度レベルを変更せずに処理順序を微調整します
- **数式:** `最終順序 = 優先度 × 10,000 + 順序調整 + 元のエントリ順序`

### **使用例**
```
ロアブック A: 優先度 3, 順序調整 +250
ロアブック B: 優先度 3, 順序調整 -100
ロアブック C: 優先度 3, 順序調整 0 (デフォルト)

最終処理順序:
1. ロアブック A: 30,250 + エントリ順序 (最初に処理)
2. ロアブック C: 30,000 + エントリ順序 (デフォルト)
3. ロアブック B: 29,900 + エントリ順序 (最後に処理)
```

### **グループチャットコントロール**
- **常に適用:** 順序調整はシングルチャットとグループチャットの両方で機能します（デフォルト）
- **グループチャットのみ:** グループチャット中にのみ順序調整を適用するには、このオプションをチェックします
- **キャラクターオーバーライド:** グループチャット内の特定のキャラクターに対して異なる順序調整を設定します

### **順序調整を使用する場合**
- **キャラクター vs ワールド:** キャラクター固有のロアブックを一般的なワールド情報よりわずかにブーストします
- **ロアの階層:** 補足情報より前に重要なロアが処理されるようにします
- **メモリ管理:** 他のコンテンツに対してメモリ/LTMエントリがアクティブになるタイミングを微調整します
- **対話の優先度:** 会話中に対話関連のロアブックがアクティブになるタイミングを制御します

---

## 🎭 グループチャットのキャラクターオーバーライド

![Group Chat Specific Settings](https://github.com/aikohanasaki/imagehost/blob/main/STLO%20group.png)

### **キャラクターごとのカスタマイズ**
グループチャットでは、各キャラクターが個々のターンで異なるロアブックの動作を持つことができます：

- **キャラクター固有の優先度:** アリスは優先度5のロアブックを使用し、ボブは同じロアブックを優先度2で使用することができます
- **個別の順序調整:** 各キャラクターは同じロアブックに対してカスタムの順序調整値を持つことができます

### **グループチャットのオーバーライドの仕組み**
1. **オーバーライドの設定:** ロアブックの設定で、「グループチャットのオーバーライド」セクションを展開します
2. **キャラクターの選択:** このロアブックの特別設定を適用するキャラクターを選択します
3. **カスタム値の設定:** 各キャラクターは独自の優先度と順序調整設定を持つことができます
4. **自動適用:** グループチャット中、アリスの番になると彼女のオーバーライド設定が使用され、ボブの番になると彼の設定が使用されます

### **シナリオ例**
- **キャラクター中心のロアブック:** キャラクター自身の個人ロアブックを優先度5に設定し、他のキャラクターには優先度1に設定します
- **ロアの専門化:** 学者のキャラクターは学術的なロアブックで高い優先度を得ますが、戦士は低い優先度になります
- **順序の微調整:** 正の順序調整でキャラクター固有のコンテンツをブーストします

### **重要な注意点**
- **シングルチャットの動作:** キャラクターオーバーライドはシングルキャラクターチャットでは無視されます（デフォルトのロアブック設定が使用されます）
- **フォールバックロジック:** 特定のオーバーライドがないキャラクターは、ロアブックのデフォルト設定を使用します
- **競合なし:** グループチャットからシングルチャットに切り替えると、オーバーライド状態が自動的にクリアされます

---


## ⚙️ 設定と構成

### **ロアブックごとの設定**
- **優先度:** 説明ラベル付きの1〜5のスケール
- **順序調整:** 優先度レベル内で処理順序を微調整します
- **予算管理:** 各ロアブックが使用できるワールド情報/コンテキスト予算を制限します。
  - **デフォルト:** ロアブックごとの制限なし（STLOによるトリミングなし）。SillyTavernが決定します。STLOはエントリを順序付けするだけです。
  - **ワールド情報予算の割合:** このロアブックをワールド情報トークンプールの割合に制限します。
  - **最大コンテキストの割合:** モデルの最大使用可能コンテキストウィンドウの割合で制限します。
  - **固定トークン:** このロアブックに特定のトークン制限を設定します。
  - 予算は`getMaxContextSize()`からの現在のコンテキストサイズを使用して計算され、適用には「均等に」戦略が必要です。
  - **ヒント:** デフォルト（0）ではSillyTavernが予算を管理します。1に固定すると、ロアブックが抑制されます。
- **自動保存:** 設定は変更時に自動的に保存されます

### **グローバルな動作**
- **戦略の検証:** 「均等に」戦略が必要かどうかを自動的に検出します
- **スマート警告:** 実際の生成中にのみ互換性の警告を表示します（チャット読み込み時ではない）
- **生成の追跡:** 自動的な挨拶とユーザーが開始した生成を区別します

---

## 🚨 互換性と警告

### **戦略の要件**
STLOが機能するには、「均等に」ワールド情報挿入戦略が必要です。拡張機能が次を検出した場合：
- 特別なロアブック設定が構成されている
- 戦略が「均等に」に設定されていない

警告ポップアップが表示され、次のオプションが提供されます：
- **生成を停止:** 設定を修正するために生成を停止します
- **STLOを無効化:** ロアブックの順序付けなしで続行します

### **ベストプラクティス**
- STLOがアクティブな場合は、常に「均等に」戦略を使用してください
- 最初に短い会話で優先度設定をテストしてください
- 微調整のために順序調整を控えめに使用してください

---

## 🔧 高度な使用法

### **複数のロアブックのシナリオ**
- **キャラクター + ワールド:** キャラクターのロアブックを高/最高優先度に設定します
- **メモリ/LTM:** メモリを最低優先度に設定します
- **順序制御:** 優先度レベル内で細かく制御するために順序調整を使用します

### **グループチャットの高度な戦略**
- **キャラクターの専門化:** 各キャラクターに関連するロアブックで高い優先度を与えます
  - 学者: 「魔法理論」のロアブックで高い優先度、通常の「戦闘戦術」で通常の優先度
  - 戦士: 「戦闘戦術」のロアブックで高い優先度、「魔法理論」で低い優先度
- **順序の微調整:** 順序調整を使用してキャラクター固有のコンテンツをブーストします
  - キャラクター固有のロアブック: そのキャラクターに対して+500の順序調整
  - 一般的なロアブック: 0の順序調整（デフォルト）
- **ロアの一貫性:** キャラクター固有の情報がそのキャラクターのターン中にのみ表示されるようにします
  - キャラクターのバックストーリーのロアブックをそのキャラクターに対して優先度5に設定し、他のキャラクターには優先度1に設定します

---

*ClineとさまざまなLLMでバイブコーディングされました。* 🎯✨
