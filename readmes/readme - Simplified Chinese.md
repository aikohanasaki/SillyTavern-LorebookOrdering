# 📚 故事书排序 (SillyTavern 扩展)

---

🌐 **欢迎阅读本项目的简体中文详细指南：**
👉 [STMB 与 STLO 指南（简体中文）](../guides/STMB%20and%20STLO%20-%20Simplified%20Chinese.md)

一个SillyTavern扩展，为世界信息（World Info）添加了故事书级别的优先级管理和预算功能。允许完全控制哪些故事书优先激活，并可以限制“贪婪”的故事书。非常适合拥有多个故事书并需要对世界信息行为进行精细控制的用户。

---

💡 **想要充分利用记忆管理？**
建议将 STLO 与 [SillyTavern-MemoryBooks (STMB)](https://github.com/aikohanasaki/SillyTavern-MemoryBooks) 一起使用以获得最佳效果！  
请参阅 [STMB + STLO 指南](../guides/STMB%20and%20STLO%20-%20Simplified%20Chinese.md) 获取设置技巧及记忆优先级管理说明。

---

🆕 **现在支持群聊中的角色特定覆盖和精确顺序调整！**

**📋 [版本历史与更新日志](CHANGELOG.md)**

## 常见问题
通过世界信息面板中的“Lorebook Ordering”按钮访问设置（当有故事书可用时，会出现在搜索框旁边）。

![STLO Button](https://github.com/aikohanasaki/imagehost/blob/main/STLO.png)

---

## 📋 先决条件

- **SillyTavern:** 1.13.5+ (建议使用最新版本)
- **世界信息策略:** 必须使用 "evenly" 插入策略才能使STLO正常工作
- **多个故事书:** 当您有多个需要优先处理的故事书时，此扩展最有用

## 💡 推荐的全局世界信息/故事书激活设置
在以下设置下测试通过：

- **插入策略:** "evenly" (STLO工作所必需)
- **最大递归步数:** 2 (通用建议)

---

## 🚀 开始使用

### 1. **安装与配置**
- 在您的SillyTavern扩展文件夹中安装此扩展
- 确保您有多个可用的故事书
- 在SillyTavern设置中将世界信息插入策略设置为 "evenly"

![Extension Button](https://github.com/aikohanasaki/imagehost/blob/main/settings.png)

### 2. **访问设置**
- 在SillyTavern中打开世界信息面板
- 查找搜索框旁边的“Lorebook Ordering”按钮
- 点击打开故事书管理模态框

### 3. **配置优先级**
- 从下拉列表中选择一个故事书
- 设置优先级（1=最低到5=最高，3=默认）
- 设置预算（如果需要）
- 根据需要配置顺序调整
- 保存并为其他故事书重复此操作

![Basic (global) settings](https://github.com/aikohanasaki/imagehost/blob/main/STLO%20basic.png)

---

## 🎯 优先级

### **优先级系统**
- **最高 (5):** 故事书条目最先激活，并在预算分配中获得优先权
- **高 (4):** 高于默认优先级
- **默认 (3):** 标准SillyTavern行为（与原始设置相同）
- **低 (2):** 低于默认优先级
- **最低 (1):** 故事书条目最后激活

### **工作原理**
- 在世界信息激活期间，优先级较高的故事书会首先被处理
- 仅在 "evenly" 插入策略下有效

---

## 📊 顺序调整系统

### **超越优先级的微调**
顺序调整系统允许在相同优先级内精确控制故事书条目的处理顺序：

- **调整范围:** 在优先级计算的基础上增加-10,000到+10,000的值
- **精确控制:** 在不改变优先级的情况下微调处理顺序
- **数学公式:** `最终顺序 = 优先级 × 10,000 + 顺序调整 + 原始条目顺序`

### **使用示例**
```
故事书 A: 优先级 3, 顺序调整 +250
故事书 B: 优先级 3, 顺序调整 -100
故事书 C: 优先级 3, 顺序调整 0 (默认)

最终处理顺序:
1. 故事书 A: 30,250 + 条目顺序 (最先处理)
2. 故事书 C: 30,000 + 条目顺序 (默认)
3. 故事书 B: 29,900 + 条目顺序 (最后处理)
```

### **群聊控制**
- **始终应用:** 顺序调整在单人聊天和群聊中均有效（默认）
- **仅限群聊:** 勾选此选项以仅在群聊期间应用顺序调整
- **角色覆盖:** 为群聊中的特定角色设置不同的顺序调整

### **何时使用顺序调整**
- **角色 vs 世界:** 将角色特定的故事书提升到略高于一般世界信息的水平
- **知识层级:** 确保关键知识在补充信息之前处理
- **记忆管理:** 微调记忆/长期记忆条目相对于其他内容的激活时间
- **对话优先级:** 控制与对话相关的故事书在对话中的激活时机

---

## 🎭 群聊角色覆盖

![Group Chat Specific Settings](https://github.com/aikohanasaki/imagehost/blob/main/STLO%20group.png)

### **按角色定制**
在群聊中，不同角色现在可以在各自的回合中拥有不同的故事书行为：

- **角色特定优先级:** Alice可能以优先级5使用某个故事书，而Bob则以优先级2使用同一个故事书
- **独立顺序调整:** 每个角色可以为同一个故事书设置自定义的顺序调整值

### **群聊覆盖如何工作**
1. **配置覆盖:** 在故事书设置中，展开“群聊覆盖”部分
2. **选择角色:** 选择哪些角色将获得此故事书的特殊设置
3. **设置自定义值:** 每个角色都可以有独特的优先级和顺序调整设置
4. **自动应用:** 在群聊期间，轮到Alice时，她会使用她的覆盖设置；轮到Bob时，他会使用他的设置

### **示例场景**
- **角色中心的故事书:** 将角色的个人故事书对他们自己设置为优先级5，对其他人设置为优先级1
- **知识专精:** 学者角色在学术故事书上获得高优先级，战士则获得低优先级
- **顺序微调:** 通过正向顺序调整来提升角色特定内容

### **重要说明**
- **单人聊天行为:** 角色覆盖在单人聊天中被忽略（使用默认故事书设置）
- **回退逻辑:** 没有特定覆盖的角色将使用故事书的默认设置
- **无冲突:** 从群聊切换到单人聊天会自动清除覆盖状态

---


## ⚙️ 设置与配置

### **按故事书设置**
- **优先级:** 1-5级，带有描述性标签
- **顺序调整:** 在优先级内部微调处理顺序
- **预算控制:** 限制每个故事书可以使用的世界信息/上下文预算。
  - **默认:** 没有每个故事书的限制（没有STLO修剪）；由SillyTavern决定。STLO只对条目进行排序。
  - **世界信息预算的百分比:** 将此故事书限制为世界信息令牌池的一个百分比。
  - **最大上下文的百分比:** 按模型最大可用上下文窗口的百分比进行限制。
  - **固定令牌数:** 为此故事书设置一个特定的令牌限制。
  - 预算是使用`getMaxContextSize()`中的当前上下文大小计算的，并且需要“evenly”策略来强制执行。
  - **提示:** 默认值（0）让SillyTavern管理预算。固定为1将切断该故事书。
- **自动保存:** 更改设置时自动保存

### **全局行为**
- **策略验证:** 自动检测是否需要 "evenly" 策略
- **智能警告:** 仅在实际生成期间显示兼容性警告（而不是在聊天加载时）
- **生成跟踪:** 区分自动问候和用户发起的生成

---

## 🚨 兼容性与警告

### **策略要求**
STLO需要 "evenly" 世界信息插入策略才能正常工作。当扩展检测到：
- 配置了特殊的故事书设置
- 策略未设置为 "evenly"

您会看到一个警告弹出窗口，其中包含以下选项：
- **停止生成:** 先暂停生成以修复设置
- **禁用STLO:** 继续但不使用故事书排序

### **最佳实践**
- 当STLO激活时，始终使用 "evenly" 策略
- 首先通过简短对话测试优先级设置
- 谨慎使用顺序调整进行微调

---

## 🔧 高级用法

### **多故事书场景**
- **角色 + 世界:** 将角色故事书设置为高/最高优先级
- **记忆/长期记忆:** 将记忆设置为最低优先级
- **顺序控制:** 使用顺序调整在优先级内进行精细控制

### **群聊高级策略**
- **角色专精:** 为每个角色在其相关的故事书上设置高优先级
  - 学者: 在“魔法理论”故事书上为高优先级，在“战斗战术”上为普通优先级
  - 战士: 在“战斗战术”故事书上为高优先级，在“魔法理论”上为低优先级
- **顺序微调:** 使用顺序调整来提升角色特定内容
  - 角色特定的故事书: 为该角色+500顺序调整
  - 通用故事书: 0顺序调整（默认）
- **知识一致性:** 确保角色特定的信息只在他们的回合出现
  - 角色背景故事书对该角色设置为优先级5，对其他人设置为优先级1

---

*由Cline和各种LLM倾情打造。* 🎯✨
