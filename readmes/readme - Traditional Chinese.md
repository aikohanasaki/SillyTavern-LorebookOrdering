# 📚 故事書排序 (SillyTavern 擴充功能)

---

🌐 **歡迎閱讀本專案的繁體中文詳細指南：**
👉 [STMB 與 STLO 指南（繁體中文）](../guides/STMB%20and%20STLO%20-%20Traditional%20Chinese.md)

一個SillyTavern擴充功能，為世界資訊（World Info）增加了故事書層級的優先級管理和預算功能。可以完全控制哪些故事書首先啟用，並限制「貪婪」的故事書。非常適合擁有多個故事書並需要對世界資訊行為進行精細控制的使用者。

---

💡 **想要充分發揮記憶管理的威力嗎？**
建議將 STLO 與 [SillyTavern-MemoryBooks (STMB)](https://github.com/aikohanasaki/SillyTavern-MemoryBooks) 搭配使用以獲得最佳效果！  
請參閱 [STMB + STLO 指南](../guides/STMB%20and%20STLO%20-%20Traditional%20Chinese.md) 以獲取設定技巧及記憶優先順序配置說明。

---

🆕 **現在支援群組聊天中的角色特定覆蓋和精確順序調整！**

**📋 [版本歷史與更新日誌](CHANGELOG.md)**

## 常見問題
通過世界資訊面板中的「Lorebook Ordering」按鈕存取設定（當有故事書可用時，會出現在搜尋框旁邊）。

![STLO Button](https://github.com/aikohanasaki/imagehost/blob/main/STLO.png)

---

## 📋 先決條件

- **SillyTavern:** 1.13.5+ (建議使用最新版本)
- **世界資訊策略:** 必須使用 "evenly" 插入策略才能讓STLO正常運作
- **多個故事書:** 當您有多個需要優先處理的故事書時，此擴充功能最有用

## 💡 建議的全域世界資訊/故事書啟用設定
在以下設定下測試通過：

- **插入策略:** "evenly" (STLO運作所需)
- **最大遞歸步數:** 2 (一般建議)

---

## 🚀 入門指南

### 1. **安裝與設定**
- 在您的SillyTavern擴充功能資料夾中安裝此擴充功能
- 確保您有多個可用的故事書
- 在SillyTavern設定中將世界資訊插入策略設定為 "evenly"

![Extension Button](https://github.com/aikohanasaki/imagehost/blob/main/settings.png)

### 2. **存取設定**
- 在SillyTavern中開啟世界資訊面板
- 找到搜尋框旁邊的「Lorebook Ordering」按鈕
- 點擊以開啟故事書管理彈出視窗

### 3. **設定優先級**
- 從下拉式選單中選擇一本故事書
- 設定優先級（1=最低至5=最高，3=預設）
- 設定預算（如果需要）
- 如有需要，設定順序調整
- 儲存並為其他故事書重複此操作

![Basic (global) settings](https://github.com/aikohanasaki/imagehost/blob/main/STLO%20basic.png)

---

## ⌨️ 斜線指令: /stlo

直接從聊天輸入框中為特定的故事書開啟STLO優先級和預算模態視窗。

- 描述: 快速跳轉到給定故事書的STLO設定。
- 用法:
  ```
  /stlo <故事書名稱>
  ```
- 參數:
  - 故事書名稱 (不區分大小寫)。您可以輸入帶有空格的名稱而無需引號；引號是可選的。
- 範例:
  - `/stlo 我的故事書`
  - `/stlo "世界傳說"`
  - `/stlo 愛麗絲`

功能:
- 在世界資訊編輯器中選擇匹配的故事書。
- 為該故事書開啟ST故事書排序模態視窗。

注意:
- 需要一個現有的世界資訊檔案。如果沒有選擇/可用的檔案，您將看到：「請先建立或選擇一個世界資訊檔案。」
- 如果名稱與任何故事書都不匹配，您將看到：「未找到故事書：名稱」
- 如果您省略了故事書名稱，您將看到用法提示：「用法：/stlo <故事書名稱>」
- STLO仍然需要「evenly」插入策略才能使排序和預算生效。

---

## 🎯 優先級

### **優先級系統**
- **最高 (5):** 故事書條目最先啟用，並在預算分配中獲得優先
- **高 (4):** 高於預設優先級
- **預設 (3):** 標準SillyTavern行為（與原始設定相同）
- **低 (2):** 低於預設優先級
- **最低 (1):** 故事書條目最後啟用

### **運作方式**
- 在世界資訊啟用期間，優先級較高的故事書會先被處理
- 僅在 "evenly" 插入策略下有效

---

## 📊 順序調整系統

### **超越優先級的微調**
順序調整系統允許在相同優先級內精確控制故事書條目的處理順序：

- **調整範圍:** 在優先級計算的基礎上增加-10,000到+10,000的值
- **精確控制:** 在不改變優先級的情況下微調處理順序
- **數學公式:** `最終順序 = 優先級 × 10,000 + 順序調整 + 原始條目順序`

### **使用範例**
```
故事書 A: 優先級 3, 順序調整 +250
故事書 B: 優先級 3, 順序調整 -100
故事書 C: 優先級 3, 順序調整 0 (預設)

最終處理順序:
1. 故事書 A: 30,250 + 條目順序 (最先處理)
2. 故事書 C: 30,000 + 條目順序 (預設)
3. 故事書 B: 29,900 + 條目順序 (最後處理)
```

### **群組聊天控制**
- **一律套用:** 順序調整在單人聊天和群組聊天中均有效（預設）
- **僅限群組聊天:** 勾選此選項以僅在群組聊天期間套用順序調整
- **角色覆蓋:** 為群組聊天中的特定角色設定不同的順序調整

### **何時使用順序調整**
- **角色 vs 世界:** 將角色特定的故事書提升到略高於一般世界資訊的水平
- **知識層級:** 確保關鍵知識在補充資訊之前處理
- **記憶管理:** 微調記憶/長期記憶條目相對於其他內容的啟用時間
- **對話優先級:** 控制與對話相關的故事書在對話中的啟用時機

---

## 🎭 群組聊天角色覆蓋

![Group Chat Specific Settings](https://github.com/aikohanasaki/imagehost/blob/main/STLO%20group.png)

### **按角色自訂**
在群組聊天中，不同角色現在可以在各自的回合中擁有不同的故事書行為：

- **角色特定優先級:** Alice可能以優先級5使用某個故事書，而Bob則以優先級2使用同一個故事書
- **獨立順序調整:** 每個角色可以為同一個故事書設定自訂的順序調整值

### **群組聊天覆蓋如何運作**
1. **設定覆蓋:** 在故事書設定中，展開「群組聊天覆蓋」部分
2. **選擇角色:** 選擇哪些角色將獲得此故事書的特殊設定
3. **設定自訂值:** 每個角色都可以有獨特的優先級和順序調整設定
4. **自動套用:** 在群組聊天期間，輪到Alice時，她會使用她的覆蓋設定；輪到Bob時，他會使用他的設定

### **範例場景**
- **以角色為中心的故事書:** 將角色的個人故事書對他們自己設定為優先級5，對其他人設定為優先級1
- **知識專精:** 學者角色在學術故事書上獲得高優先級，戰士則獲得低優先級
- **順序微調:** 透過正向順序調整來提升角色特定內容

### **重要注意事項**
- **單人聊天行為:** 角色覆蓋在單人聊天中會被忽略（使用預設故事書設定）
- **備援邏輯:** 沒有特定覆蓋的角色將使用故事書的預設設定
- **無衝突:** 從群組聊天切換到單人聊天會自動清除覆蓋狀態

---


## ⚙️ 設定與配置

### **按故事書設定**
- **優先級:** 1-5級，附有描述性標籤
- **順序調整:** 在優先級內部微調處理順序
- **預算控制:** 限制每個故事書可以使用的世界資訊/上下文預算。
  - **預設:** 沒有每個故事書的限制（沒有STLO修剪）；由SillyTavern決定。STLO只對條目進行排序。
  - **世界資訊預算的百分比:** 將此故事書限制為世界資訊令牌池的一個百分比。
  - **最大上下文的百分比:** 按模型最大可用上下文視窗的百分比進行限制。
  - **固定令牌數:** 為此故事書設定一個特定的令牌限制。
  - 預算是使用`getMaxContextSize()`中的目前上下文大小計算的，並且需要「evenly」策略來強制執行。
  - **提示:** 預設值（0）讓SillyTavern管理預算。固定為1將切斷該故事書。
- **自動儲存:** 變更設定時自動儲存

### **全域行為**
- **策略驗證:** 自動偵測是否需要 "evenly" 策略
- **智慧警告:** 僅在實際生成期間顯示相容性警告（而非在聊天載入時）
- **生成追蹤:** 區分自動問候和使用者啟動的生成

---

## 🚨 相容性與警告

### **策略要求**
STLO需要 "evenly" 世界資訊插入策略才能正常運作。當擴充功能偵測到：
- 設定了特殊的故事書設定
- 策略未設定為 "evenly"

您會看到一個警告彈出視窗，其中包含以下選項：
- **停止生成:** 先暫停生成以修復設定
- **停用STLO:** 繼續但不使用故事書排序

### **最佳實踐**
- 當STLO啟用時，一律使用 "evenly" 策略
- 首先透過簡短對話測試優先級設定
- 謹慎使用順序調整進行微調

---

## 🔧 進階用法

### **多故事書場景**
- **角色 + 世界:** 將角色故事書設定為高/最高優先級
- **記憶/長期記憶:** 將記憶設定為最低優先級
- **順序控制:** 使用順序調整在優先級內進行精細控制

### **群組聊天進階策略**
- **角色專精:** 為每個角色在其相關的故事書上設定高優先級
  - 學者: 在「魔法理論」故事書上為高優先級，在「戰鬥戰術」上為普通優先級
  - 戰士: 在「戰鬥戰術」故事書上為高優先級，在「魔法理論」上為低優先級
- **順序微調:** 使用順序調整來提升角色特定內容
  - 角色特定的故事書: 為該角色+500順序調整
  - 通用故事書: 0順序調整（預設）
- **知識一致性:** 確保角色特定的資訊只在他們的回合出現
  - 角色背景故事書對該角色設定為優先級5，對其他人設定為優先級1

---

*由Cline和各種LLM傾情打造。* 🎯✨
